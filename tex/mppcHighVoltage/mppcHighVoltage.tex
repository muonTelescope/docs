\section{MPPC High Voltage Supply}

Surface mount module that provides $\SI{52.5}{\volt}$ to $\SI{57.5}{\volt}$ in $\SI{20}{\milli\volt}$ increments. Also contains a 2 input 24bit ADC to allow for closed loop control of the voltage, and read in a thermistor mounted near the sensor. Rendering of a fully assembled module shown in Figure~\ref{fig:withEMIshield}.

\fig{./tex/mppcHighVoltage/img/withEMIshield}{Board rendering with EMI shield.}{withEMIshield}

\subsection{Hardware}
The module uses a MAX1932 APD bias voltage boost converter and NAU7802SGI 24bit Analog to Digital converter (ADC) for reading temperature and output voltage. The complete bill of materials including assembly and testing is detailed in Table~\ref{tab:mppcHighVoltageBOM}.

\begin{table}[h]
    \centering    
    \begin{adjustbox}{width=\textwidth,center}
        \begin{tabular}{lllllrrr}
            \multicolumn{8}{ c }{MPPC High Voltage BOM} \\ \hline
            \textbf{Ref-Des} & \textbf{Function}      & \textbf{Description}                    & \textbf{P/N}                & \textbf{Digikey P/N}   & \textbf{QTY} & \textbf{Unit Price} & \textbf{Ext Price}  \\ \hline \hline
            C1               & Input Decoupling       & 1µF 16V Ceramic Capacitor X7R 1206      & \texttt{160R18W105KV4E    } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=709-1068-1-ND    }{\texttt{709-1068-1-ND    }}      & 1     & 0.0890     & 0.09  \\
            C2               & Boost Capacitor        & 0.047µF 500V Ceramic Capacitor X7R 1206 & \texttt{C1206C473KCRACTU  } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=399-6743-1-ND    }{\texttt{399-6743-1-ND    }}      & 1     & 0.1300     & 0.13  \\
            C3               & Pre Filter Capacitor   & 0.10µF 250V Ceramic Capacitor X7R 1206  & \texttt{C1206C104KARACTU  } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=399-4674-1-ND    }{\texttt{399-4674-1-ND    }}      & 1     & 0.1485     & 0.15  \\
            C4               & Post Filter Capacitor  & CAP CER 1UF 100V X7R 1206               & \texttt{12061C105KAT2A    } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=478-6226-1-ND    }{\texttt{478-6226-1-ND    }}      & 1     & 0.1570     & 0.16  \\
            C5               & Compensation Capacitor & CAP CER 0.22UF 16V Y5V 0402             & \texttt{CL05F224ZO5NNNC   } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=1276-1060-1-ND   }{\texttt{1276-1060-1-ND   }}      & 1     & 0.0112     & 0.01  \\
            D1               & Boost Diode            & DIODE GEN PURP 100V 200MA SOD80         & \texttt{LL4148            } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=LL4148FSCT-ND    }{\texttt{LL4148FSCT-ND    }}      & 1     & 0.0420     & 0.04  \\
            L1               & Boost Inductor         & FIXED IND 150UH 320MA 2.4 OHM           & \texttt{SRN4018-151M      } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=SRN4018-151MCT-ND}{\texttt{SRN4018-151MCT-ND}}      & 1     & 0.2400     & 0.24  \\
            L2               & Smoothing Inductor     & FIXED IND 330UH 90MA 15.99 OHM          & \texttt{CBC2518T331K      } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=587-3059-1-ND    }{\texttt{587-3059-1-ND    }}      & 1     & 0.1400     & 0.14  \\
            Q1               & Boost Switch           & MOSFET N-CH 100V 0.17A SOT-23           & \texttt{BSS123L           } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=BSS123LCT-ND     }{\texttt{BSS123LCT-ND     }}      & 1     & 0.1032     & 0.10  \\
            R1               & Current Sens Resistor  & RES SMD 806 OHM 0.1\% 1/16W 0402        & \texttt{RT0402BRD07806RL  } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=YAG1481CT-ND     }{\texttt{YAG1481CT-ND     }}      & 1     & 0.1276     & 0.13  \\
            R2, R6           & Adjustment Span/Temp   & RES SMD 100K OHM 0.1\% 1/16W 0402       & \texttt{RT0402BRD07100KL  } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=YAG1343CT-ND     }{\texttt{YAG1343CT-ND     }}      & 2     & 0.1276     & 0.26  \\
            R3               & Minimum Voltage Res    & RES SMD 2.37KOHM 0.1\% 1/16W 0402       & \texttt{CPF0402B2K37E1    } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=A102770CT-ND     }{\texttt{A102770CT-ND     }}      & 1     & 0.2082     & 0.21  \\
            R4               & DAC Resistor           & RES SMD 24.9KOHM 0.1\% 1/16W 0402       & \texttt{RT0402BRD0724K9L  } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=YAG1393CT-ND     }{\texttt{YAG1393CT-ND     }}      & 1     & 0.1276     & 0.13  \\
            R5               & Compensation Res       & RES SMD 20 OHM 0.1\% 1/16W 0402         & \texttt{CPF0402B20RE1     } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=A102706CT-ND     }{\texttt{A102706CT-ND     }}      & 1     & 0.1973     & 0.20  \\
            U1               & Boost Controller       & IC SUPPLY BIAS APD 12-TQFN              & \texttt{MAX1932ETC+T      } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=MAX1932ETC+TCT-ND}{\texttt{MAX1932ETC+TCT-ND}}      & 1     & 7.2828     & 7.28  \\
            U2               & ADC                    & IC ADC 24BIT I2C/SRL 16-SOP             & \texttt{NAU7802SGI        } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=NAU7802SGI-ND    }{\texttt{NAU7802SGI-ND    }}      & 1     & 1.3442     & 1.34  \\
            C6               & 0.1uF                  & 0.10µF 10V Ceramic Capacitor X5R 0402   & \texttt{CL05A104KP5NNNC   } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=1276-1022-1-ND   }{\texttt{1276-1022-1-ND   }}      & 2     & 0.0048     & 0.01  \\
            C7               & 1uF                    & 1µF 6.3V Ceramic Capacitor X6S 0402     & \texttt{GRM155C80J105KE15D} & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=490-6281-1-ND    }{\texttt{490-6281-1-ND    }}      & 1     & 0.0055     & 0.01  \\
            C8               & 10uF                   & 10µF 6.3V Ceramic Capacitor X5R 0603    & \texttt{GRM155R60G106ME44D} & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=490-10693-1-ND   }{\texttt{490-10693-1-ND   }}      & 1     & 0.0380     & 0.04  \\
            S1               & RF Shield              & RFI SHIELD CAN 20X15X3MM                & \texttt{S02-20150300      } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=952-2632-ND      }{\texttt{952-2632-ND      }}      & 1     & 3.5300     & 3.53  \\
            R7               & 220k 1\%               & RES SMD 220K OHM 1\% 1/16W 0402         & \texttt{RC0402FR-07220KL  } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=311-220KLRCT-ND  }{\texttt{311-220KLRCT-ND  }}      & 1     & 0.0054     & 0.01  \\
            R9               & 270k 1\%               & RES SMD 270K OHM 1\% 1/16W 0402         & \texttt{RC0402FR-07270KL  } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=311-270KLRCT-ND  }{\texttt{311-270KLRCT-ND  }}      & 1     & 0.0054     & 0.01  \\
            R8               & 10k 0.1\%              & RES SMD 10K OHM 1\% 1/16W 0402          & \texttt{RC0402FR-0710KL   } & \href{http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=311-10.0KLRCT-ND }{\texttt{311-10.0KLRCT-ND }}      & 1     & 0.0054     & 0.01  \\ \hline
            \multicolumn{5}{ r }{ \href{http://www.oshpark.com/}{PCB Manufacture}}                                                                                                                                                                         & 1     & 1.5333     & 1.53  \\ 
            \multicolumn{5}{ r }{ \href{http://www.smallbatchassembly.com/}{Assembly}}                                                                                                                                                                     & 1     & 9.3000     & 9.30  \\ \cline{5-8}
            \multicolumn{5}{ r }{ Testing (Labour)}                                                                                                                                                                                                        & 0.05  & 30.0000    & 1.50  \\ 
            \multicolumn{5}{ r }{ Calibration (Labour)}                                                                                                                                                                                                    & 0.05  & 30.0000    & 1.50  \\ \cline{5-8}
            \multicolumn{7}{ r }{ Subtotal}                                                                                                                                                                                                                                     & 28.03 \\
        \end{tabular}
    \end{adjustbox}
    \caption{Bill of materials All prices in USD.}
    \label{tab:mppcHighVoltageBOM}
\end{table}

\fig{./tex/mppcHighVoltage/img/noShieldFront}{EMI shield removed showing switching region.}{noShieldFront}

\subsubsection{High Voltage}
The module uses a \href{http://datasheets.maximintegrated.com/en/ds/MAX1932.pdf}{MAX1932} APD bias voltage boost converter to create and maintain the output voltage. The voltage range, and step size is dictated with setting \texttt{R2}, \texttt{R3}, and \texttt{R4}. The minimum and maximum voltage set using the equations for on page 7 of the datasheet, and there are 8 bits (256) intermediate values that are possible the corresponding schematic is show in in Figure~\ref{fig:hvSchematic}. The high switching portion was designed with general SMPS design requirements (short high current loops, separated ground planes, EMI shielding) providing a low ripple output ($<\SI{5}{\milli\volt}_{pp}$ ripple) and no significant back EMF.

\fig{./tex/mppcHighVoltage/img/hvSchematic}{Schematic for high voltage boost converter.}{hvSchematic}

\subsubsection{ADC}
The analogue to digital converter is a one designed for high precision and low sampling rate. The \href{http://www.nuvoton.com/resource-files/NAU7802%20Data%20Sheet%20V1.7.pdf}{NAU7802SGI} is marketed at the load sensing market, but the high precision and low sampling rate lends itself well to the closed loop control and monitoring application. The high voltage is divided by 50 and the thermistor is put across a equivalent 100K static resistor to go along with the 100K NTC found on the MPPC sensor module to act as a voltage divider, see Figure~\ref{fig:assemblySchematic} for details.

\fig{./tex/mppcHighVoltage/img/assemblySchematic}{Schematic showing contacts, adc, and high voltage hierarchy block.}{assemblySchematic}

\subsection{Software}
Each module has two buses that run to it, I\textsuperscript{2}C (pronounced I-two-C) and SPI. SPI requires data, clock, and a chip-select meaning each device on the bus will need an independent chip select. I\textsuperscript{2}C devices have a fixed address therefore it is not possible to have multiple devices on the same bus. This can be remedied by placing multiple devices in front of a I\textsuperscript{2}C multiplexer. Table~\ref{tab:pinOut} lists their functions.

\begin{table}[!h]
    \centering
    \begin{tabular}{ r l l }
        \multicolumn{3}{ c }{MPPC High Voltage Pinout} \\
        \hline
        \textbf{Pin} & \textbf{Label} & \textbf{Description}                     \\ \hline \hline
        1            & \texttt{3V3}   & Regulated $\SI{3.3}{\volt}$ in           \\
        2            & \texttt{CS}    & \emph{SPI} bus Chip Select               \\
        3            & \texttt{SCLK}  & \emph{SPI} bus clock                     \\
        4            & \texttt{DIN}   & \emph{SPI} bus data in                   \\
        5            & \texttt{GND}   & Common Ground                            \\
        6            & \texttt{DRDY}  & ADC conversion done                      \\
        7            & \texttt{SCL}   & \emph{I\textsuperscript{2}C} bus clock   \\
        8            & \texttt{SDA}   & \emph{I\textsuperscript{2}C} bus data    \\
    \end{tabular}
    \caption{Pins and thier fuctions.}    
    \label{tab:pinOut}
\end{table}

\subsubsection{High Voltage}
The SPI bus is connected directly to the MAX1932. Chip select is active low and data is sent MSB (most significant bit first). Sending bytes to it sets the voltage. Setting them to \texttt{0x00} turns off the DC-DC converter portion. As values increase to \texttt{0xFF (127)}, the output voltage falls, linearly. Example code for Arduino that cycles through all possible values is shown in Listing~\ref{lst:max1932}.

\lstinputlisting[language=C++, caption="max1932.ino", label={lst:max1932}]{./tex/mppcHighVoltage/source/max1932.ino}

\subsubsection{ADC}
The ADC communicates through the I\textsuperscript{2}C bus, the device address is permanently programmed to \texttt{0101010 (0x2A)}. It is fully compliant with the I\textsuperscript{2}C protocol and the datasheet has the register map (page 28) and protocol description (page 14).

\lstinputlisting[language=C++, caption="nau7802.ino", label={lst:nau7802}]{./tex/mppcHighVoltage/source/nau7802.ino}

\fig{./tex/mppcHighVoltage/img/mppcBack}{Back is flat to allow flush mounting to mother-board.}{mppcBack}

% For appendix Nau7802 Library
\begin{landscape}
\lstinputlisting[language=C++, caption="NAU7802.h", basicstyle=\tiny, , label={lst:nau7802.h}]{./tex/mppcHighVoltage/source/nau7802/nau7802.h}
\lstinputlisting[language=C++, caption="Nau7802.cpp", basicstyle=\tiny, label={lst:nau7802.cpp}]{./tex/mppcHighVoltage/source/nau7802/nau7802.cpp}
\end{landscape}

